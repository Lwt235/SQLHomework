<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.competition.mapper.NotificationMapper">

    <!-- Result Map -->
    <resultMap id="notificationResultMap" type="com.competition.entity.Notification">
        <id property="notificationId" column="notification_id"/>
        <result property="userId" column="user_id"/>
        <result property="notificationType" column="notification_type"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="read" column="is_read"/>
        <result property="relatedId" column="related_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="is_deleted"/>
    </resultMap>

    <!-- Select All -->
    <select id="findAll" resultMap="notificationResultMap">
        SELECT * FROM Notification WHERE is_deleted = FALSE
    </select>

    <!-- Select By Id -->
    <select id="findById" resultMap="notificationResultMap">
        SELECT * FROM Notification 
        WHERE notification_id = #{notificationId} 
          AND is_deleted = FALSE
    </select>

    <!-- Select By User Id And Deleted Order By Created At Desc -->
    <select id="findByUserIdAndDeletedOrderByCreatedAtDesc" resultMap="notificationResultMap">
        SELECT * FROM Notification 
        WHERE user_id = #{userId} 
          AND is_deleted = #{deleted} 
        ORDER BY created_at DESC
    </select>

    <!-- Select By User Id And Read And Deleted Order By Created At Desc -->
    <select id="findByUserIdAndReadAndDeletedOrderByCreatedAtDesc" resultMap="notificationResultMap">
        SELECT * FROM Notification 
        WHERE user_id = #{userId} 
          AND is_read = #{read} 
          AND is_deleted = #{deleted} 
        ORDER BY created_at DESC
    </select>

    <!-- Count By User Id And Read And Deleted -->
    <select id="countByUserIdAndReadAndDeleted" resultType="long">
        SELECT COUNT(*) FROM Notification 
        WHERE user_id = #{userId} 
          AND is_read = #{read} 
          AND is_deleted = #{deleted}
    </select>

    <!-- Mark All As Read By User Id -->
    <update id="markAllAsReadByUserId">
        UPDATE Notification 
        SET is_read = TRUE 
        WHERE user_id = #{userId} 
          AND is_read = FALSE 
          AND is_deleted = FALSE
    </update>

    <!-- Soft Delete By Id -->
    <update id="softDeleteById">
        UPDATE Notification 
        SET is_deleted = TRUE 
        WHERE notification_id = #{notificationId}
    </update>

    <!-- Soft Delete By Ids -->
    <update id="softDeleteByIds">
        UPDATE Notification 
        SET is_deleted = TRUE 
        WHERE notification_id IN
        <foreach collection="notificationIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Insert -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="notificationId" keyColumn="notification_id">
        INSERT INTO Notification (
            user_id, notification_type, title, content, is_read, related_id,
            created_at, updated_at, is_deleted
        ) VALUES (
            #{userId}, #{notificationType}, #{title}, #{content}, #{read}, #{relatedId},
            NOW(), NOW(), FALSE
        )
    </insert>

    <!-- Update -->
    <update id="update">
        UPDATE Notification 
        SET user_id = #{userId},
            notification_type = #{notificationType},
            title = #{title},
            content = #{content},
            is_read = #{read},
            related_id = #{relatedId},
            updated_at = NOW()
        WHERE notification_id = #{notificationId}
    </update>

</mapper>
