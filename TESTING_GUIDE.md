# 竞赛管理系统更新 - 测试指南

## 已完成的更改

本次更新解决了您提出的所有问题：

### 1. ✅ 添加了评审开始时间（review_start）字段

**问题**：管理员创建比赛时未提供评审开始时间选择，数据库中review_start字段也是null

**解决方案**：
- 在数据库Competition表中添加了`review_start`字段
- 在管理后台的竞赛创建/编辑表单中添加了"评审开始时间"选择器
- 该字段为可选字段，如果不填写则评审阶段时间不可见（保持向后兼容）

### 2. ✅ 修复了时间轴不更新的问题

**问题**：通过管理员账户调整系统时间后，竞赛状态更新但时间轴未更新

**解决方案**：
- 修改了竞赛详情页面，使其从系统时间API获取当前时间
- 时间轴现在使用系统时间（而非浏览器本地时间）来判断当前阶段
- 当系统时间调整后，刷新页面即可看到更新的时间轴

### 3. ✅ 实现了更具体的竞赛状态

**问题**：希望修改现有的比赛状态，改成更具体的如：报名中、进行中（提交作品）、评审中、公示中等

**解决方案**：
- 实现了5个新的细粒度状态：
  - **报名中** (`registering`) - 报名阶段
  - **进行中-提交作品** (`submitting`) - 作品提交阶段
  - **评审中** (`reviewing`) - 评审阶段
  - **公示中** (`publicizing`) - 获奖公示阶段
  - **已结束** (`finished`) - 竞赛完成
- 保留了对旧状态的兼容性（published、ongoing等）

## 如何测试

### 测试前准备

1. **更新数据库**：
   ```bash
   cd /home/runner/work/SQLHomework/SQLHomework
   mysql -u [你的用户名] -p competition_management < src/main/resources/db/migration_add_review_start.sql
   ```

2. **启动后端**：
   ```bash
   mvn spring-boot:run
   ```

3. **启动前端**：
   ```bash
   cd frontend
   npm install  # 如果还没安装依赖
   npm run dev
   ```

### 测试场景 1：创建带评审时间的竞赛

1. 以管理员身份登录系统
2. 进入"管理后台" > "竞赛管理"
3. 点击"创建竞赛"按钮
4. 填写竞赛信息：
   - 竞赛名称：测试竞赛
   - 简称：测试
   - 报名开始时间：2024-01-01 00:00
   - 提交开始时间：2024-02-01 00:00
   - **评审开始时间：2024-03-01 00:00** （新增字段）
   - 奖项公示开始：2024-04-01 00:00
5. 点击"保存"
6. **验证**：确认竞赛创建成功，没有报错

### 测试场景 2：查看新的竞赛状态

1. 创建一个竞赛，设置以下时间：
   - 报名开始：当前时间 - 1天
   - 提交开始：当前时间 + 1天
   - 评审开始：当前时间 + 2天
   - 奖项公示：当前时间 + 3天
2. 进入"竞赛管理"列表
3. **验证**：竞赛状态应该显示为"报名中"（蓝色标签）
4. 进入"竞赛详情"页面
5. **验证**：时间轴应该高亮显示"报名阶段"为进行中

### 测试场景 3：调整系统时间并查看时间轴更新

1. 以管理员身份登录
2. 进入"系统管理" > "时间管理"
3. 启用测试模式
4. 设置测试时间为某个竞赛的作品提交阶段（submit_start 和 review_start之间）
5. 进入"竞赛管理"，刷新页面
6. **验证**：竞赛状态应该更新为"进行中-提交作品"（绿色标签）
7. 进入该竞赛的详情页面
8. **验证**：时间轴应该高亮显示"作品提交阶段"为进行中
9. 重复步骤4-8，测试其他时间阶段：
   - 评审阶段（review_start 和 award_publish_start之间）-> 状态应为"评审中"
   - 公示阶段（award_publish_start 和 award_publish_start+1天之间）-> 状态应为"公示中"

### 测试场景 4：验证时间顺序验证

1. 创建竞赛时，尝试设置不合法的时间顺序：
   - 提交开始时间 < 报名开始时间
   - 评审开始时间 < 提交开始时间
   - 奖项公示时间 < 评审开始时间
2. **验证**：系统应该显示错误提示，不允许保存

### 测试场景 5：不填写评审时间（向后兼容）

1. 创建竞赛，**不填写**评审开始时间
2. 只填写：报名开始、提交开始、奖项公示开始时间
3. 点击保存
4. **验证**：竞赛创建成功
5. 进入竞赛详情页面
6. **验证**：时间轴中评审阶段显示"（内部评审，在奖项公示前完成）"

## 状态流转示例

假设创建一个竞赛：
- 报名开始：2024-01-01 00:00
- 提交开始：2024-02-01 00:00
- 评审开始：2024-03-01 00:00
- 奖项公示：2024-04-01 00:00

状态流转如下：
```
草稿 (draft) 
  ↓ 当前时间 >= 2024-01-01 00:00
报名中 (registering) 
  ↓ 当前时间 >= 2024-02-01 00:00
进行中-提交作品 (submitting) 
  ↓ 当前时间 >= 2024-03-01 00:00
评审中 (reviewing) 
  ↓ 当前时间 >= 2024-04-01 00:00
公示中 (publicizing) 
  ↓ 当前时间 >= 2024-04-02 00:00
已结束 (finished)
```

## 常见问题

### Q1: 我的现有竞赛会受影响吗？
A: 不会。系统保持向后兼容：
- 现有竞赛的review_start字段会被设置为award_publish_start的值
- 旧的状态值（published、ongoing）仍然可以正常工作
- UI会正确显示旧状态

### Q2: review_start字段是必填的吗？
A: 不是。这是一个可选字段。如果不填写：
- 系统按原有逻辑运行
- 评审阶段在时间轴上显示为"内部评审"
- 状态流转正常：报名中 -> 进行中 -> 公示中 -> 已结束

### Q3: 如何确认时间轴使用的是系统时间？
A: 
1. 调整系统时间到未来某个时间点
2. 刷新竞赛详情页面
3. 如果时间轴更新了，说明使用的是系统时间
4. 如果看到警告提示"无法获取系统时间，使用浏览器时间"，说明系统时间API失败了

### Q4: 状态自动更新的频率是多少？
A: 
- 自动更新：每小时更新一次
- 手动更新：管理员可以调用API `/api/competitions/refresh-status` 立即更新所有竞赛状态

## 技术文档

详细的技术文档请查看：
- `COMPETITION_STATUS_UPDATE.md` - 完整的更新说明和API文档

## 需要帮助？

如果您在测试过程中遇到问题，请：
1. 检查浏览器控制台是否有错误信息
2. 检查后端日志（包含状态更新的详细信息）
3. 确认数据库迁移脚本是否成功执行
4. 在GitHub Issue中提供详细的错误信息和复现步骤
